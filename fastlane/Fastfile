# fastlane/Fastfile
# Beekeepr - Single app (App Store only)

require "fileutils"

opt_out_usage
default_platform(:ios)

APP_NAME = "Beekeepr"

SCHEME    = ENV["IOS_SCHEME"] || "Beekeepr"
WORKSPACE = ENV["IOS_WORKSPACE"] || "ios/#{SCHEME}.xcworkspace"

BUILD_DIR   = File.expand_path("../build", __dir__) # <repo>/build
IOS_IPA     = File.join(BUILD_DIR, "#{APP_NAME}.ipa")
ANDROID_AAB = File.join(BUILD_DIR, "#{APP_NAME}.aab")

# ---------------------------------------
# Helpers
# ---------------------------------------

def project_root
  File.expand_path("..", __dir__)
end

def ensure_build_dir!
  FileUtils.mkdir_p(File.expand_path(BUILD_DIR, __dir__))
end

def expo_prebuild(platform)
  sh("cd #{project_root} && npx expo prebuild --platform #{platform} --clean")
end

def ensure_ios_bundle_id!
  bundle_id = ENV["IOS_BUNDLE_ID"].to_s.strip
  UI.user_error!("Missing IOS_BUNDLE_ID") if bundle_id.empty?
  bundle_id
end

def ensure_ios_team_id!
  team_id = ENV["IOS_TEAM_ID"].to_s.strip
  UI.user_error!("Missing IOS_TEAM_ID") if team_id.empty?
  team_id
end

def setup_asc_api_key!
  UI.user_error!("Missing ASC_KEY_ID") if ENV["ASC_KEY_ID"].to_s.strip.empty?
  UI.user_error!("Missing ASC_ISSUER_ID") if ENV["ASC_ISSUER_ID"].to_s.strip.empty?

  key_content = ENV["ASC_KEY_P8"]

  UI.user_error!("Missing ASC_KEY_P8") if key_content.to_s.strip.empty?

  app_store_connect_api_key(
    key_id: ENV["ASC_KEY_ID"],
    issuer_id: ENV["ASC_ISSUER_ID"],
    key_content: key_content,
    is_key_content_base64: ENV["ASC_KEY_P8_BASE64"] == "true"
  )
end

def resolve_play_json_key_path!
  return ENV["PLAY_JSON_KEY_PATH"] if ENV["PLAY_JSON_KEY_PATH"].to_s.strip.length > 0

  json_data = ENV["PLAY_JSON_KEY_DATA"].to_s
  UI.user_error!("Missing PLAY_JSON_KEY_DATA") if json_data.strip.length == 0

  tmp_dir = File.join(__dir__, ".tmp")
  FileUtils.mkdir_p(tmp_dir)

  path = File.join(tmp_dir, "play-service-account.json")
  File.write(path, json_data)
  path
end

# ==========================================
# iOS
# ==========================================

platform :ios do

  desc "Sync App Store signing (match)"
  lane :sync_signing do
    setup_asc_api_key!

    match(
      type: "appstore",
      readonly: ENV["CI"] == "true",
      team_id: ensure_ios_team_id!,
      git_url: ENV["MATCH_GIT_URL"],
      git_branch: "master",
      app_identifier: [ensure_ios_bundle_id!]
    )
  end

  desc "Build signed IPA for TestFlight / App Store"
  lane :build do
    ensure_build_dir!

    bundle_id = ensure_ios_bundle_id!
    team_id   = ensure_ios_team_id!

    UI.message("Building iOS (#{APP_NAME})")

    # Generate ios folder
    expo_prebuild("ios")

    # Set team
    update_project_team(
      path: "ios/Beekeepr.xcodeproj",
      teamid: team_id
    )

    cocoapods(
      podfile: "ios/Podfile",
      use_bundle_exec: true
    )

    # Pull certs & profiles
    sync_signing

    # Force manual signing for Release
    update_code_signing_settings(
      use_automatic_signing: false,
      path: "ios/Beekeepr.xcodeproj",
      team_id: team_id,
      bundle_identifier: bundle_id,
      profile_name: "match AppStore #{bundle_id}",
      code_sign_identity: "Apple Distribution"
    )

    gym(
      workspace: WORKSPACE,
      scheme: SCHEME,
      configuration: "Release",
      clean: true,
      export_method: "app-store",
      export_team_id: team_id,
      xcargs: "CODE_SIGN_STYLE=Manual DEVELOPMENT_TEAM=#{team_id} CODE_SIGN_IDENTITY='Apple Distribution' PROVISIONING_PROFILE_SPECIFIER='match AppStore #{bundle_id}'",
      export_options: {
        method: "app-store",
        signingStyle: "manual",
        teamID: team_id,
        provisioningProfiles: {
          bundle_id => "match AppStore #{bundle_id}"
        }
      },
      output_directory: BUILD_DIR,
      output_name: "#{APP_NAME}.ipa"
    )

    UI.success("IPA built at #{IOS_IPA}")
  end

  desc "Upload to TestFlight"
  lane :upload_testflight do |options|
    ipa_path = options[:ipa] || IOS_IPA
    UI.user_error!("IPA not found at #{ipa_path}.") unless File.exist?(ipa_path)
  
    setup_asc_api_key!
  
    pilot(
      ipa: ipa_path,
      app_identifier: ensure_ios_bundle_id!,
      skip_waiting_for_build_processing: true,
      changelog: ENV["RELEASE_NOTES"]
    )
  end

  desc "Submit to App Store review"
  lane :submit_review do
    setup_asc_api_key!

    deliver(
      app_identifier: ensure_ios_bundle_id!,
      submit_for_review: true,
      automatic_release: false,
      force: true,
      skip_screenshots: true,
      skip_metadata: true
    )
  end
end

# ==========================================
# Android
# ==========================================

platform :android do

  desc "Build Android AAB"
  lane :build do
    ensure_build_dir!

    UI.message("Building Android (#{APP_NAME})")

    expo_prebuild("android")

    gradle(
      project_dir: "../android",
      task: "bundleRelease"
    )

    sh("cp ../android/app/build/outputs/bundle/release/*.aab #{ANDROID_AAB}")

    UI.success("AAB built at #{ANDROID_AAB}")
  end

  desc "Upload to Google Play"
  lane :play do
    UI.user_error!("AAB not found. Run android build first.") unless File.exist?(ANDROID_AAB)

    supply(
      aab: ANDROID_AAB,
      track: (ENV["PLAY_TRACK"] || "internal"),
      json_key: resolve_play_json_key_path!,
      release_status: "draft",
      changelog: ENV["RELEASE_NOTES"],
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )
  end
end
